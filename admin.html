<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>설문 결과 대시보드 (관리자)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; }
    </style>
</head>
<body class="text-gray-800">

    <div id="loginOverlay" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm transform transition-all">
            <div class="text-center mb-6">
                <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-lock text-2xl text-blue-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">관리자 접속</h2>
                <p class="text-gray-500 text-sm mt-1">접근 권한 확인이 필요합니다.</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <input type="password" id="adminPw" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                        placeholder="비밀번호를 입력하세요"
                        onkeyup="if(window.event.keyCode==13){checkPw()}">
                </div>
                <button onclick="checkPw()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-md transition duration-200">
                    확인
                </button>
                <a href="index.html" class="block text-center text-gray-400 text-sm hover:text-gray-600 mt-4">
                    <i class="fa-solid fa-arrow-left mr-1"></i> 설문 페이지로 돌아가기
                </a>
            </div>
        </div>
    </div>

    <div id="adminContent" class="hidden opacity-0 transition-opacity duration-500">
        
        <header class="bg-slate-800 text-white py-6 shadow-md">
            <div class="container mx-auto px-6 flex justify-between items-center">
                <h1 class="text-2xl font-bold"><i class="fa-solid fa-chart-pie mr-2"></i>설문 결과 대시보드</h1>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-slate-400 bg-slate-700 px-3 py-1 rounded-full">
                        <i class="fa-solid fa-user-shield mr-1"></i> 관리자 모드
                    </span>
                    <a href="index.html" class="text-sm hover:text-blue-300 transition">
                        나가기
                    </a>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-6 py-8">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <h3 class="text-gray-500 text-sm font-medium mb-1">총 응답자 수</h3>
                    <p class="text-4xl font-bold text-blue-600" id="totalCount">0명</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <h3 class="text-gray-500 text-sm font-medium mb-1">AI 긍정 인식 (Q7 평균)</h3>
                    <p class="text-4xl font-bold text-green-600" id="aiScore">0.0</p>
                    <p class="text-xs text-gray-400 mt-1">5점 만점 기준</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-center">
                    <button onclick="downloadCSV()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition flex items-center justify-center shadow-sm">
                        <i class="fa-solid fa-file-excel mr-2"></i> 결과 엑셀(CSV) 다운로드
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-bold mb-4 border-b pb-2">문항별 평균 점수</h3>
                    <div class="relative h-64 w-full">
                        <canvas id="avgChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-bold mb-4 border-b pb-2">AI 활용(Q10) vs 스마트폰 의존(Q6)</h3>
                    <div class="relative h-64 w-full flex justify-center">
                        <canvas id="compareChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="text-lg font-bold">응답 상세 데이터</h3>
                    <button onclick="clearData()" class="text-red-500 text-sm hover:text-red-700 hover:bg-red-50 px-3 py-1 rounded transition">
                        <i class="fa-solid fa-trash-can mr-1"></i> 데이터 전체 삭제
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 uppercase">
                            <tr>
                                <th class="px-6 py-3">학번</th>
                                <th class="px-6 py-3">이름</th>
                                <th class="px-6 py-3">사용시간</th>
                                <th class="px-6 py-3">제출일시</th>
                                <th class="px-6 py-3 text-center">총점</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody" class="divide-y divide-slate-100">
                            </tbody>
                    </table>
                </div>
                <div id="noDataMessage" class="p-8 text-center text-gray-400 hidden">
                    아직 제출된 데이터가 없습니다.
                </div>
            </div>

        </main>
    </div>

    <script>
        // 전역 변수로 차트 객체 저장 (중복 생성 방지 및 업데이트용)
        let avgChartInstance = null;
        let compareChartInstance = null;

        // 질문 목록
        const questions = [
            "학습 활용", "오락 활용", "소통 활용", "조절 어려움", 
            "중요 도구", "불안감(의존)", "AI 긍정인식", 
            "디지털 교재", "줄이기 노력", "생성형 AI 사용"
        ];

        // 데이터 로드
        const rawData = localStorage.getItem('surveyData');
        const data = rawData ? JSON.parse(rawData) : [];

        // 페이지 로드 시에는 비밀번호 입력창에만 포커스 (차트 렌더링 X)
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('adminPw').focus();
        });

        // --- 비밀번호 확인 및 초기화 함수 ---
        function checkPw() {
            const input = document.getElementById('adminPw').value;
            // 비밀번호 확인
            if(input === 'jcjeil123') {
                const loginOverlay = document.getElementById('loginOverlay');
                const adminContent = document.getElementById('adminContent');

                // 1. 로그인 창 숨기기
                loginOverlay.classList.add('hidden');
                
                // 2. 관리자 콘텐츠 보이기
                adminContent.classList.remove('hidden');
                // 부드러운 전환 효과를 위해 약간의 지연 후 opacity 변경
                setTimeout(() => {
                    adminContent.classList.remove('opacity-0');
                }, 10);

                // 3. [중요] 화면이 보인 후에 데이터 렌더링 실행
                // 화면이 그려질 시간을 아주 잠깐 주기 위해 setTimeout 사용 권장
                setTimeout(() => {
                    updateStats();
                    renderCharts();
                    renderTable();
                }, 50);

            } else {
                alert('비밀번호가 올바르지 않습니다.');
                document.getElementById('adminPw').value = '';
                document.getElementById('adminPw').focus();
            }
        }

        function updateStats() {
            document.getElementById('totalCount').innerText = data.length + "명";
            if(data.length > 0) {
                const aiSum = data.reduce((acc, curr) => acc + curr.answers[6], 0); // Q7 index는 6
                document.getElementById('aiScore').innerText = (aiSum / data.length).toFixed(1);
            } else {
                document.getElementById('noDataMessage').classList.remove('hidden');
            }
        }

        function renderCharts() {
            if (data.length === 0) return;

            // 기존 차트가 있다면 삭제 (오류 방지)
            if (avgChartInstance) avgChartInstance.destroy();
            if (compareChartInstance) compareChartInstance.destroy();

            // 데이터 가공
            const sums = new Array(10).fill(0);
            data.forEach(item => {
                item.answers.forEach((ans, idx) => sums[idx] += ans);
            });
            const avgs = sums.map(sum => (sum / data.length).toFixed(1));

            // Chart 1: 문항별 평균
            const ctxAvg = document.getElementById('avgChart').getContext('2d');
            avgChartInstance = new Chart(ctxAvg, {
                type: 'bar',
                data: {
                    labels: questions,
                    datasets: [{
                        label: '평균 점수',
                        data: avgs,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false, // 컨테이너 크기에 맞춤
                    scales: { 
                        x: { min: 0, max: 5, grid: { display: false } },
                        y: { grid: { display: false } }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Chart 2: 도넛 차트
            const highAIUser = data.filter(d => d.answers[9] >= 4).length;
            const highDepend = data.filter(d => d.answers[5] >= 4).length;
            
            const ctxCompare = document.getElementById('compareChart').getContext('2d');
            compareChartInstance = new Chart(ctxCompare, {
                type: 'doughnut',
                data: {
                    labels: ['생성형 AI 고활용자(4점이상)', '스마트폰 고의존자(4점이상)', '기타'],
                    datasets: [{
                        data: [highAIUser, highDepend, Math.max(0, data.length - highAIUser - highDepend)], 
                        backgroundColor: ['#10b981', '#ef4444', '#e2e8f0'],
                        borderWidth: 0
                    }]
                },
                options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function renderTable() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            const sortedData = [...data].reverse();

            sortedData.forEach(item => {
                const totalScore = item.answers.reduce((a,b)=>a+b, 0);
                const row = `
                    <tr class="hover:bg-slate-50 transition border-b border-slate-50">
                        <td class="px-6 py-4 font-medium text-gray-900">${item.studentId}</td>
                        <td class="px-6 py-4">${item.name}</td>
                        <td class="px-6 py-4 text-gray-600">${item.usageTime}</td>
                        <td class="px-6 py-4 text-gray-400 text-xs">${item.timestamp}</td>
                        <td class="px-6 py-4 text-center">
                            <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded">${totalScore}</span>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function downloadCSV() {
            if (data.length === 0) {
                alert("다운로드할 데이터가 없습니다.");
                return;
            }
            let csvContent = "\uFEFF제출일시,학번,이름,사용시간,Q1,Q2,Q3,Q4,Q5,Q6,Q7,Q8,Q9,Q10\n";
            data.forEach(row => {
                const rowStr = [
                    `"${row.timestamp}"`, `"${row.studentId}"`, `"${row.name}"`, `"${row.usageTime}"`,
                    ...row.answers
                ].join(",");
                csvContent += rowStr + "\n";
            });
            const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "설문결과_" + new Date().toISOString().slice(0,10) + ".csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function clearData() {
            if(confirm('정말 모든 데이터를 삭제하시겠습니까? 삭제 후에는 복구할 수 없습니다.')) {
                localStorage.removeItem('surveyData');
                alert('모든 데이터가 삭제되었습니다.');
                location.reload();
            }
        }
    </script>
</body>
</html>